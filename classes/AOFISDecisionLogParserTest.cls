@IsTest
private class AOFISDecisionLogParserTest {

    @IsTest
    private static void testHappyPath() {
        String testData = '{"form":{"name":"accountsandfunding","tracking_code":"T9FH3WF","job_reference_code":"PV4DHML"},"applicant":{"person":{"first_name":"Paul","last_name":"Ferguson","birth_date":"1958-01-01","tax_id":"666-37-1340","primary_address":{"line_1":"4400 Central Way","line_2":"Ste 510","city":"Chubbuck","state":"ID","country":"USA","postal_code":"83202"},"identification":{"type":"drivers_license","id_number":"101800775","issuing_authority":"CO","issue_date":"2018-01-01","expire_date":"2028-01-01"},"credit_score":{"score":null,"score_date":null},"home_phone":{"country_code":null,"phone_number":"3081231234","extension":null},"mobile_phone":{"country_code":null,"phone_number":null,"extension":null},"work_phone":{"country_code":null,"phone_number":null,"extension":null},"email":"dmagill@iccu.com"},"persona":"Unknown","membership_eligibility":"I\'m not a permanent resident, but am an employee, employer, student and/or retiree working in Idaho.","system_info":[{"system_name":"FIS","system_display_name":"Qualifile","status":"DECLINE","decision":"DECLINE","everything":"{\\"birthDt\\":\\"10081961\\",\\"chexOk\\":\\"true\\",\\"chexResultId\\":\\"549521598\\",\\"cityNm\\":\\"Saint Jo\\",\\"validGovernmentNumberTxt\\":\\"SSN AVAILABLE FOR RANDOMIZED ISSUANCE                       SSN:Y\\",\\"consumerDisputeQty\\":\\"000\\",\\"paidClosureQty\\":\\"006\\",\\"closureReasonCategoryCd\\":\\"03\\",\\"closureReasonCategoryTxt\\":\\"ACCOUNT ABUSE                                                    \\",\\"closureReasonCd\\":\\"A \\",\\"closureReasonTxt\\":\\"NON-SUFFICIENT FUNDS(NSF) ACTIVITY                               \\",\\"collectionAmountTxt\\":\\"MONIES OWED                        \\",\\"collectionPaidCd\\":\\"Y\\",\\"collectionsPaymentRecordedDt\\":\\"04/13/2015\\",\\"consumerDisputeCd\\":\\"N\\",\\"identityTheftCd\\":\\"N\\",\\"originalChargeOffAmt\\":\\"950.00\\",\\"reportedCityNm\\":\\"SAINT JO            \\",\\"reportedDt\\":\\"12/28/2014\\",\\"reportedFirstNm\\":\\"LENNY       \\",\\"reportedGovernmentNbr\\":\\"666990266\\",\\"reportedLastNm\\":\\"JOSEPH              \\",\\"reportedMiddleNm\\":\\"V\\",\\"reportedPostalPlusFourCd\\":\\"762652236\\",\\"reportedStateCd\\":\\"TX\\",\\"reportedStreetAddressTxt\\":\\"118 S BROAD ST           \\",\\"customerBranchCityNm\\":\\"WOODBURY            \\",\\"customerBranchNm\\":\\"MINNESOTA OFFICE                 \\",\\"customerBranchPostalPlusFourCd\\":\\"55125    \\",\\"customerBranchStateCd\\":\\"MN\\",\\"customerBranchStreetAddressTxt\\":\\"7805 HUDSON ROAD              \\",\\"customerNm\\":\\"CHEXSYSTEMS, INC.                  \\",\\"settlementPaidCd\\":\\"Y\\",\\"settlementPaidTxt\\":\\"ANY AMOUNTS OWED HAVE BEEN PAID                                  \\",\\"totalClosures\\":\\"6\\",\\"unpaidClosureQty\\":\\"000\\",\\"soldClosuresQty\\":\\"0\\",\\"partiallyPaidClosuresQty\\":\\"0\\",\\"inquiryCustBranchCityNm\\":\\"MINNEAPOLIS         \\",\\"inquiryCustBranchName\\":\\"SEVENTH BANK                                      \\",\\"inquiryCustBranchPostalPlusFourCd\\":\\"55407    \\",\\"inquiryCustBranchStateCd\\":\\"MN\\",\\"inquiryCustBranchStreetAddress\\":\\"7 SEVENTH STREET         \\",\\"inquiryCustNm\\":\\"SEVENTH BANK                                      \\",\\"inquiryDt\\":\\"12/03/2016\\",\\"previousInquiryCityNm\\":\\"SAINT JO            \\",\\"previousInquiryFirstNm\\":\\"LENNY       \\",\\"previousInquiryGovernmentNbr\\":\\"666990266\\",\\"previousInquiryID\\":\\"011000007\\",\\"previousInquiryLastNm\\":\\"JOSEPH              \\",\\"previousInquiryMiddleNm\\":\\"V\\",\\"previousInquiryPostalPlusFourCd\\":\\"762652236\\",\\"previousInquiryStateCd\\":\\"TX\\",\\"previousInquiryStreetAddressTxt\\":\\"118 S BROAD ST           \\",\\"numberInquiryCustomersTotalQty\\":\\"7\\",\\"previousInquiryTotalQty\\":\\"7\\",\\"validDriversLicenseTxt\\":\\"VALID DRIVERS LICENSE FORMAT\\",\\"inquiryTrackingId\\":\\"672500827\\",\\"previousInquiriesQty\\":\\"7 previous inquiries by 7 Fl(s)\\",\\"unpaidRetailItemsFoundTxt\\":\\" 1 ITEM(S) FOR $ 300                                                \\",\\"unpaidRetailItemsNotFoundTxt\\":\\"False\\",\\"purchasedDebtNotFoundCd\\":\\"Y\\",\\"purchasedDebtTotal\\":\\"0\\",\\"purchasedDebtDisputedQty\\":\\"0\\",\\"purchasedDebtUnpaidQty\\":\\"0\\",\\"purchasedDebtPaidQty\\":\\"0\\",\\"purchaseddebtPartiallyPaidQty\\":\\"0\\",\\"purchasedDebtSoldQty\\":\\"0\\",\\"accountAcceptanceTxt\\":\\"DECLINE\\",\\"accountActionTxt1\\":\\"LOW QUALIFILE SCORE           \\",\\"accountActionTxt2\\":\\"PROVIDE ADVERSE ACTION FORM   \\",\\"accountActionTxt3\\":\\"CHECK BOX FOR CHEXSYSTEMS     \\",\\"creditBureauScoreNbr\\":\\"0000\\",\\"reasonCd\\":\\"AY\\",\\"reasonTxt\\":\\"ASSET OWNERSHIP HISTORY UNKNOWN                             \\",\\"scoreNbr\\":\\"0452\\",\\"consumerDetailReferenceNbr\\":\\"18GQ37732376\\",\\"countryNm\\":\\"USA\\",\\"firstNm\\":\\"Lenny\\",\\"governmentNbr\\":\\"666990266\\",\\"identificationStateCd\\":\\"TX\\",\\"identificationStateNbr\\":\\"71000070\\",\\"lastNm\\":\\"Joseph\\",\\"postalPlusFourCd\\":\\"76265\\",\\"stateCd\\":\\"TX\\",\\"streetAddressTxt\\":\\"118 S Broad St\\",\\"transactionTrackingId\\":\\"1532618932246:15994:UXAP302U_Z1.FNFIS.COM:\\"}","user_action":"","tracking_number":"HGXQRZ7"}]},"coApplicants":[],"products":[{"product_name":"Free Checking","major_type":"CK","minor_type":"CKBA"},{"product_name":"Share Savings","major_type":"SAV","minor_type":"SREG"}],"fundingInfo":{"from_account_uuid":null,"payment_type":"ACH","is_using_external_processor":true,"opened_accounts":[{"account":{"unique_id":"0af4be6b-be26-4313-80d1-90a5dcc00f55","account_name":null,"account_number":"723216904","balance":100.0,"available_balance":null,"is_active":null,"product":{"product_name":"Free Checking","major_type":"CK","minor_type":"CKBA"}},"from_account":{"unique_id":null,"account_name":null,"account_number":null,"balance":null,"available_balance":null,"is_active":null,"product":{"product_name":null,"major_type":null,"minor_type":null}},"funding_amount":100.0,"funding_source":"ACH"},{"account":{"unique_id":"034f9e3f-4c2b-4fe5-8a6f-eaccad29c890","account_name":null,"account_number":"723216894","balance":25.0,"available_balance":null,"is_active":null,"product":{"product_name":"Share Savings","major_type":"SAV","minor_type":"SREG"}},"from_account":{"unique_id":null,"account_name":null,"account_number":null,"balance":null,"available_balance":null,"is_active":null,"product":{"product_name":null,"major_type":null,"minor_type":null}},"funding_amount":25.0,"funding_source":"ACH"}]},"reports":[],"app_status":"Completed","version":"3","external_crm_id":null}';
        AOApplicationRestRequest request = AOApplicationRestRequest.parse(testData);
        AOApplicationInfo appInfo = new AOApplicationInfo(request);

        Test.startTest();

        AOFISDecisionLogParser parser = new AOFISDecisionLogParser();
        try {
            parser.getFriendlyName();
            parser.parsePayload(request.applicant.system_info, appInfo);
        } catch(Exception e) {
            System.assert(false, 'Threw an exception: ' + e + ' stack trace: ' + e.getStackTraceString());
        }

        Test.stopTest();

        String systemName = parser.getSystemName();
        AOInteractionResult result = appInfo.systemInteractionResults.get(systemName);

        System.assertNotEquals(null, result);
        System.assertEquals(AOInteractionResult.State.SUCCESS, result.state);
        System.assertEquals('Acceptance: DECLINE', result.message);
        System.assertNotEquals(null, appInfo.backgroundCheckReport);
        System.assertEquals(0, appInfo.errors.size(), 'Error: ' + appInfo.errors);
    }

    @IsTest
    private static void testError() {
        String testData = '{"form":{"name":"accountsandfunding","tracking_code":"T9FH3WF","job_reference_code":"PV4DHML"},"applicant":{"person":{"first_name":"Paul","last_name":"Ferguson","birth_date":"1958-01-01","tax_id":"666-37-1340","primary_address":{"line_1":"4400 Central Way","line_2":"Ste 510","city":"Chubbuck","state":"ID","country":"USA","postal_code":"83202"},"identification":{"type":"drivers_license","id_number":"101800775","issuing_authority":"CO","issue_date":"2018-01-01","expire_date":"2028-01-01"},"credit_score":{"score":null,"score_date":null},"home_phone":{"country_code":null,"phone_number":"3081231234","extension":null},"mobile_phone":{"country_code":null,"phone_number":null,"extension":null},"work_phone":{"country_code":null,"phone_number":null,"extension":null},"email":"dmagill@iccu.com"},"persona":"Unknown","membership_eligibility":"I\'m not a permanent resident, but am an employee, employer, student and/or retiree working in Idaho.","system_info":[{"system_name":"FIS","system_display_name":"Qualifile","status":"FAIL","decision":"FAIL","everything":"{\\"birthDt\\":\\"03181938\\",\\"chexOk\\":\\"false\\",\\"chexResultId\\":\\"549533658\\",\\"cityNm\\":\\"Colebrook\\",\\"errorInformation\\":\\"Unknown ChexSystems Error.\\",\\"errorCd\\":\\"Unknown ChexSystems Error.\\",\\"errorTxt\\":\\"Unknown ChexSystems Error.\\",\\"numberInquiryCustomersTotalQty\\":\\"0\\",\\"previousInquiryTotalQty\\":\\"0\\",\\"countryNm\\":\\"USA\\",\\"firstNm\\":\\"Roland\\",\\"governmentNbr\\":\\"666751140\\",\\"identificationStateCd\\":\\"NH\\",\\"identificationStateNbr\\":\\"03SHJ38181\\",\\"lastNm\\":\\"Cassidy\\",\\"postalPlusFourCd\\":\\"03576\\",\\"stateCd\\":\\"NH\\",\\"streetAddressTxt\\":\\"118 Main St\\",\\"transactionTrackingId\\":\\"1532825092190:778:UXAP302U_Z1.FNFIS.COM:\\"}","user_action":"","tracking_number":"HGXQRZ7"}]},"coApplicants":[],"products":[{"product_name":"Free Checking","major_type":"CK","minor_type":"CKBA"},{"product_name":"Share Savings","major_type":"SAV","minor_type":"SREG"}],"fundingInfo":{"from_account_uuid":null,"payment_type":"ACH","is_using_external_processor":true,"opened_accounts":[{"account":{"unique_id":"0af4be6b-be26-4313-80d1-90a5dcc00f55","account_name":null,"account_number":"723216904","balance":100.0,"available_balance":null,"is_active":null,"product":{"product_name":"Free Checking","major_type":"CK","minor_type":"CKBA"}},"from_account":{"unique_id":null,"account_name":null,"account_number":null,"balance":null,"available_balance":null,"is_active":null,"product":{"product_name":null,"major_type":null,"minor_type":null}},"funding_amount":100.0,"funding_source":"ACH"},{"account":{"unique_id":"034f9e3f-4c2b-4fe5-8a6f-eaccad29c890","account_name":null,"account_number":"723216894","balance":25.0,"available_balance":null,"is_active":null,"product":{"product_name":"Share Savings","major_type":"SAV","minor_type":"SREG"}},"from_account":{"unique_id":null,"account_name":null,"account_number":null,"balance":null,"available_balance":null,"is_active":null,"product":{"product_name":null,"major_type":null,"minor_type":null}},"funding_amount":25.0,"funding_source":"ACH"}]},"reports":[],"app_status":"Completed","version":"3","external_crm_id":null}';
        AOApplicationRestRequest request = AOApplicationRestRequest.parse(testData);
        AOApplicationInfo appInfo = new AOApplicationInfo(request);

        Test.startTest();

        AOFISDecisionLogParser parser = new AOFISDecisionLogParser();
        try {
            parser.parsePayload(request.applicant.system_info, appInfo);
        } catch(Exception e) {
            System.assert(false, 'Threw an exception: ' + e + ' stack trace: ' + e.getStackTraceString());
        }

        Test.stopTest();

        String systemName = parser.getSystemName();
        AOInteractionResult result = appInfo.systemInteractionResults.get(systemName);

        System.assertNotEquals(null, result);
        System.assertEquals(AOInteractionResult.State.SUCCESS, result.state);
        System.assertEquals('Error: Unknown ChexSystems Error.', result.message);
        System.assertEquals(null, appInfo.backgroundCheckReport);
        System.assertEquals(0, appInfo.errors.size(), 'Error: ' + appInfo.errors);
    }
}